---
layout: post
title: "Executor 之 线程池及定时器"
category: "并发"
---

<div style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6;">
<div style="line-height: 1.6;"></div>
<div style="line-height: 1.6;">
</div><div style="line-height: 1.6;">

<p style="margin: 0 0 1.1em; line-height: 1.6;"></p>
<div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;">
<ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none; line-height: 1.6;">
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">Executor 之 线程池及定时器</a><ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none; line-height: 1.6;">
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">1. Executor系列接口</a></li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2. 线程池ThreadPoolExecutor</a><ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none; line-height: 1.6;">
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.1 服务能力的逐步降级 &amp; 占用资源的自动伸缩</a><ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none; line-height: 1.6;">
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">Worker线程的逻辑</a></li>
</ul>
</li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.2 资源的懒加载和预加载</a></li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.3 拒绝服务的方式</a></li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.4 状态管理</a></li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.4 任务队列的选择</a></li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">2.5 定时器ScheduledThreadPoolExecutor</a></li>
</ul>
</li>
<li style="line-height: 1.6;"><a style="background: transparent; color: #1980e6; text-decoration: none;">3. 工厂类 Executors</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">1. Executor系列接口</h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><img alt="Alt text" class="en-media" longdesc="./1405070577041.png" name="79b9c390-a3d2-412b-892e-54b0cc0efec4" src="/assets/img/dacf292cba972f398489ca1a64001269.png" style="border: 0; vertical-align: middle; max-width: 100%;" title=""/></p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Executor</code>用于解耦任务（<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Runnable</code>）提交者和执行者，它只有一个方法<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">void execute(Runnable command)</code>，通过调用它向执行者提交任务，但无法知道执行的结果/进度，也无法拿到任务返回值。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ExecutorService</code> 继承<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Executor</code>，是一个更具体的接口。它额外提供了以下方法：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;">关闭执行者</p>
<pre style="word-break: break-word; font-family: 'Source Code Pro',monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 2px; border: 0; border-radius: 5px; text-align: start;" xml:space="preserve"><code style="font-family: 'Source Code Pro',monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; background: #23241f; padding: 18px 28px;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;">shutdown(); <span style="line-height: 1.6; color: #75715e;">// 拒绝接受任务，但继续执行旧任务</span></div><div style="line-height: 1.6;">shutdownNow();  <span style="line-height: 1.6; color: #75715e;">// 拒绝接受任务，且返回所有未执行的旧任务</span></div><div style="line-height: 1.6;">awaitTermination(<span style="line-height: 1.6; color: #f92672;">long</span>,TimeUnit);    <span style="line-height: 1.6; color: #75715e;">// 等待执行者完全关闭</span></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></code></pre></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;">查询执行者当前状态</p>
<pre style="word-break: break-word; font-family: 'Source Code Pro',monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 2px; border: 0; border-radius: 5px; text-align: start;" xml:space="preserve"><code style="font-family: 'Source Code Pro',monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; background: #23241f; padding: 18px 28px;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;">isShutdown();</div><div style="line-height: 1.6;">isTerminated();</div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></code></pre></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">submit</code>和<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">invokeall</code>系列方法 <br/>
接受<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Runnable/Callable</code>类型的参数，返回<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Future</code>，让提交者可以了解任务执行的进度/拿到执行结果。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Future</code>是提交者和执行者之间的通信手段，它代表任务的执行情况： <br/>
<img alt="Alt text" class="en-media" longdesc="./1405066079429.png" name="6e5954eb-c15d-4977-a4cc-2587a0ca9a89" src="/assets/img/3f68dfa9bd9ac873340c28e701c18508.png" style="border: 0; vertical-align: middle; max-width: 100%;" title=""/> <br/>
其中，<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">get</code>方法会阻塞直到任务被完成，常用于异步转同步的场景。   </p></li>
</ol>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ScheduledExecutorService</code>是一个定时器，它在<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ExecutorService</code>的基础上增加了若干定时/延迟/循环调度任务的方法：</p>
</div><div style="line-height: 1.6;">
<pre style="word-break: break-word; font-family: 'Source Code Pro',monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 2px; border: 0; border-radius: 5px; text-align: start;" xml:space="preserve"><code style="font-family: 'Source Code Pro',monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; background: #23241f; padding: 18px 28px;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #75715e;">// 延迟执行</span></div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, </div><div style="line-height: 1.6;">                                    <span style="line-height: 1.6; color: #f92672;">long</span> delay, </div><div style="line-height: 1.6;">                                    TimeUnit unit);</div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;">public</span> &lt;V&gt; <span style="line-height: 1.6; color: #f92672;">ScheduledFuture&lt;V&gt; <span style="line-height: 1.6; color: #a6e22e;">schedule</span><span style="line-height: 1.6; color: #f8f8f2;">(Callable&lt;V&gt; callable,</span></span></div><div style="line-height: 1.6;">                                        <span style="line-height: 1.6; color: #f92672;">long</span> delay, </div><div style="line-height: 1.6;">                                        TimeUnit unit);</div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #75715e;">// 固定频率执行（不管单个任务执行时间，间隔到了就执行）</span></div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,</div><div style="line-height: 1.6;">                                                <span style="line-height: 1.6; color: #f92672;">long</span> initialDelay,</div><div style="line-height: 1.6;">                                                <span style="line-height: 1.6; color: #f92672;">long</span> period,</div><div style="line-height: 1.6;">                                                TimeUnit unit);</div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #75715e;">// 固定延迟执行（任务1执行完和任务2开始执行之间的间隔是固定的）</span></div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command,</div><div style="line-height: 1.6;">                                                    <span style="line-height: 1.6; color: #f92672;">long</span> initialDelay,</div><div style="line-height: 1.6;">                                                    <span style="line-height: 1.6; color: #f92672;">long</span> delay,</div><div style="line-height: 1.6;">                                                    TimeUnit unit);</div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></code></pre>
</div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">2. 线程池<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ThreadPoolExecutor</code></h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ThreadPoolExecutor</code>是 <em style="line-height: 1.6;">线程池</em> 和 <em style="line-height: 1.6;">任务队列(BlockingQueue)</em> 实现的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ExecutorService</code>，和所有的<strong style="font-weight: bold; line-height: 1.6;">池</strong>一样，它的主要功能有两个：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;">降低频繁创建/销毁线程的开销；</li>
<li style="line-height: 1.6;">防止滥用线程资源</li>
</ol>
<p style="margin: 0 0 1.1em; line-height: 1.6;">作为一个对外提供服务的容器，它很多方面的实现都值得参考。</p>
</div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.1 服务能力的逐步降级 &amp; 占用资源的自动伸缩</h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;">提交任务时调用的是<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">BlockingQueue#offer()</code>方法，如果不成功则立即返回<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">false</code>，这意味着<strong style="font-weight: bold; line-height: 1.6;">任务提交者不会因为队列满而被阻塞</strong>。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">submit(...)</code>方法对传入的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Runnable</code>/<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Callable</code>包装进一个<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">FutureTask</code>，再调用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">execute(...)</code>处理，最后返回这个<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">FutureTask</code>对象。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">FutureTask</code>是一个实现了<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Runnable</code>和<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Future</code>的类，它本质上是一个任务，同时又是一个同步器，提供了具有阻塞/唤醒语义的查询和执行方法。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">execute(...)</code>处理策略如下：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">轻负载</strong> (当前线程数 &lt; <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>)：创建一个线程(内部类<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>)，该任务作为其初始任务。</li>
<li style="line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">中负载</strong> (当前线程数 = <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>)：任务入队列(<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">offer()</code>方法，客户不会阻塞)。</li>
<li style="line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">重负载</strong> (当前线程数 ∈ [<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>, <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">maximumPoolSize</code>]，且任务队列已满)：继续创建线程。</li>
<li style="line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">超负载</strong> (当前线程数 = <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">maximumPoolSize</code>，且任务队列已满)： 拒绝新任务。</li>
</ol>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 1.1em; line-height: 1.6;">随着负载增加，线程池的处理速度 <strong style="font-weight: bold; line-height: 1.6;">逐渐下降</strong>；超负荷时拒绝新请求，保证容器不挂：</p>
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">快 –&gt; 部分快，部分慢 –&gt; 慢 –&gt; 慢，且拒绝新任务</strong></p>
</blockquote></div><div style="line-height: 1.6;">
<h4 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 10.5px; margin-bottom: 10.5px; font-size: 1.25em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>线程的逻辑</h4>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>不停地从任务队列中拿任务执行，如果拿到 null，则退出。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>从<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">BlockingQueue</code>中取元素有两种选择：<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">poll(timeout)</code> 或 <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">take()</code>，如队列空二者均会阻塞，但前者有超时时间。选择策略如下：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">当前线程数 &lt;= <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>（轻负载）：使用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">take()</code></strong>，当队列为空时线程一直阻塞而不退出，原因是线程池在大部分时间都会处在轻/中负载的状态，避免此时线程的频繁创建和销毁。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">也可以更改这个默认行为。如果手动设置<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">allowCoreThreadTimeOut</code>，将用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">poll(timeout)</code>，超过指定时间还没任务线程就退出。</p></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">当前线程数 &gt; <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>（重负载）：使用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">poll(timeout)</code></strong>，负载回落后多余线程退出，避免不必要的资源占用。</p></li>
</ol>
<p style="margin: 0 0 1.1em; line-height: 1.6;">不管哪种情况，调用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">poll</code>的超时时间由参数<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">keepAliveTime</code>指定。 </p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>通过以上行为保证了容器占用的资源随负载程度而自动弹性伸缩。</p></div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.2 资源的懒加载和预加载</h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;">默认线程是懒加载的，即只有当新任务提交时才会创建<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>。可以调用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">prestartAllCoreThreads()</code>或<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">prestartCoreThread()</code>方法预启动 corePoolSize 个或1个线程，一来避免任务队列初始就有元素时没有线程执行；二来避免接受任务时在线程创建上消耗时间。</p>
</div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.3 拒绝服务的方式</h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;">当线程数和队列容量都达到上限时，容器将拒绝新来的服务请求，这是<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">RejectedExecutionHandler</code>接口负责的。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ThreadPoolExecutor</code>内部提供了以下 4 个实现：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">CallerRunsPolicy</code>：由客户线程自己执行任务；</li>
<li style="line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">AbortPolicy</code>（默认）：抛出<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">RejectedExecutionException</code>；</li>
<li style="line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">DiscardPolicy</code>：忽略，什么也不做；</li>
<li style="line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">DiscardOldestPolicy</code>：移除任务队列里呆的最久的任务(<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">poll()</code>)，重新提交。</li>
</ol>
</div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.4 状态管理</h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;">线程池的状态图如下： <br/>
<img alt="Alt text" class="en-media" longdesc="./1405154174067.png" name="e55d9ee5-b428-4e94-a099-8148a92da48a" src="/assets/img/5646cfa30d7cec46c10a3eaabc7273b5.png" style="border: 0; vertical-align: middle; max-width: 100%;" title=""/></p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">初始状态为 running；</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">进入 shutDown 和 stop 区别是：</p>
<ul style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;">shutDown: 不接受新任务，但会继续执行已有任务</li>
<li style="line-height: 1.6;">stop: 不接受新任务，也不执行已有任务；队列中的剩余任务被返回给客户</li>
</ul>
<p style="margin: 0 0 1.1em; line-height: 1.6;">当队列为空且线程数为0时，进入 tidying 状态。该状态下会调用一个预留给子类实现的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">terminated</code>方法进行额外的资源清理工作。结束后进入 terminated 状态。</p>
</div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.4 任务队列的选择</h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ThreadPoolExecutor</code> 的任务队列是可配置的。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">如果要求任务立即得到处理，可以使用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">SynchronousQueue</code>。</p>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">SynchronousQueue</code>是一个容量为0的阻塞队列，当 offer 元素时，如果当前没有线程阻塞在<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">take / poll(timeout)</code>上就立即失败；否则将元素交给其中的一个线程。因此它更像是线程之间传递对象的工具，而不是一个队列。</p>
</blockquote>
<p style="margin: 0 0 1.1em; line-height: 1.6;">使用<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">SynchronousQueue</code>时，线程池将无法缓存任务，每个任务都会立即创建一个线程来执行它，任务可以得到快速处理。这种策略下线程池最多只能处理<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">maximumPoolSize</code>个任务。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">如果可以接受任务执行的延迟，但需要尽可能多的处理任务，可以使用无界的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">LinkedBlockingQueue</code>或有界的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ArrayBlockingQueue</code>。若是前者，线程数将不超过<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">corePoolSize</code>，参数<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">maximumPoolSize</code>无效；若是后者，则需要在线程数和队列长度间权衡：短队列需要更多的线程，但这会带来更多的资源占用和 context switch；少线程则需要更长的队列，但此时吞吐量较低。</p>
</div><div style="line-height: 1.6;">
<h3 style="font-family: inherit; font-weight: bold; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 1.7em; margin: 1.2em 0 .6em 0; text-align: start; line-height: 1.6;">2.5 定时器<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ScheduledThreadPoolExecutor</code></h3>
<p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ScheduledThreadPoolExecutor</code>是<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ScheduledExecutorService</code>定时器接口的实现，它继承自<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ThreadPoolExecutor</code>，因此底层的工作原理和线程池是一样的，但其任务队列默认是<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">DelayBlockingQueue</code>的变种（不可配置）。<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Worker</code>依次从中获取最快到期的任务执行。对于需要重复执行的任务，第一次执行完毕后计算其下次执行时间，再重新入队。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">这个不太了解，以后看。</p>
</div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">3. 工厂类 <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">Executors</code></h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;">提供了创建线程池、定时器的工厂方法。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">线程池：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em; line-height: 1.6;"><li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">newCachedThreadPool()</code></p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">corePoolSize = 0， maximumPoolSize = int 最大值，keepAliveTime = 1分钟，缓存队列为<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">SynchronousQueue</code>。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">每个任务都会重用已有线程或创建一个新线程执行，直到线程数达到上限；没有任务时所有线程都会自然退出。</p></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">newFixedThreadPool</code></p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">corePoolSize = n， maximumPoolSize = n，keepAliveTime = 0，缓存队列为无界的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">LinkedBlockingQueue</code>。</p></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">newSingleThreadExecutor</code></p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">corePoolSize = 1， maximumPoolSize = 1，keepAliveTime = 0，缓存队列为无界的<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">LinkedBlockingQueue</code>。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">效果和<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">newFixedThreadPool(1)</code>一样。</p></li>
<li style="line-height: 1.6;"><p style="margin: 0 0 1.1em; line-height: 1.6;"><code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">newScheduledThreadPool 定时器</code> <br/>
创建一个定时器<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">ScheduledThreadPoolExecutor</code>，corePoolSize = n, maximumPoolSize = int 最大值，keepAliveTime = 0，缓存队列为<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">DelayedWorkQueue</code>。</p></li>
</ol></div><div style="line-height: 1.6;"></div></div>