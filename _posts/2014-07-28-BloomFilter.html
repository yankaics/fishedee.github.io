---
layout: post
title: "BloomFilter"
category: "算法"
---

<div style="line-height: 1.5; color: #2c3f51;">
<div></div>
<div>
</div><div>

<p style="margin: 0 0 1.1em;"></p>
<div><div><div>
<ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none;">
<li><a style="background: transparent; color: #1980e6; text-decoration: none;">BloomFilter</a><ul style="margin-top: 0; margin-bottom: 15px; list-style-type: none;">
<li><a style="background: transparent; color: #1980e6; text-decoration: none;">1. 原理</a></li>
<li><a style="background: transparent; color: #1980e6; text-decoration: none;">2. 误判率的计算</a></li>
<li><a style="background: transparent; color: #1980e6; text-decoration: none;">3. 实现</a></li>
<li><a style="background: transparent; color: #1980e6; text-decoration: none;">4. 其他技巧</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div></div><div>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0; text-align: start;">1. 原理</h2>
<p style="margin: 0 0 1.1em;">BloomFilter 是一种基于 <strong style="font-weight: bold;">bit 数组 + 多重hash</strong> 的数据结构，用于判断一个元素是否在一个集合中。</p>
<p style="margin: 0 0 1.1em;">BloomFilter 在内部维护一个长度为 m 的bit数组，并提供 k 个 hash 函数。当一个元素被加入集合时，用这些 hash 函数计算出 k 个数组位置并赋为 1。为了查询一个元素是否在集合中，同样地用 hash 函数计算出该元素在 bit 数组中的 k 个位置，如果全部为 1 就认为在集合中。</p>
<p style="margin: 0 0 1.1em;">当k很大时，设计k个独立的hash function是不现实并且困难的。对于一个输出范围很大的hash function（例如MD5产生的128 bits数），如果不同bit位的相关性很小，则可把此输出分割为k份。或者可将k个不同的初始值（例如0,1,2, … ,k-1）结合元素，feed给一个hash function从而产生k个不同的数。</p>
<p style="margin: 0 0 1.1em;">可以看到，BloomFilter 有两个缺点：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em;"><li>不支持 remove 元素；</li>
<li>对一个不在集合中的元素，有可能误判；而且误判率会随着元素的增多而升高。因此不适合要求精确的场合。</li>
</ol>
<p style="margin: 0 0 1.1em;">BloomFilter 最大的优点是它是基于 bit 数组的，不保存元素本身，因此非常节省空间；同等规模的集合，BloomFilter 占用的空间可能只有 HashSet 的 1/4 或更少。</p>
</div><div>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0; text-align: start;">2. 误判率的计算</h2>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; line-height: 1.45; margin-bottom: 0;">m:    bit 数组长度 <br/>
    n:    集合元素个数 <br/>
    k:    hash 函数个数 <br/>
    p:    误判概率</p>
</blockquote>
<p style="margin: 0 0 1.1em;">很显然，误判概率 p 是关于 m/n/k 的函数:</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="15.75" longdesc="__SVG__34d8b0287a4fc5080eb68a83371cfe5f" name="12cf0b62-9fc9-41b4-825c-95a200779978" src="/assets/img/50bed5ebe879957797bba5d846fb2371" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="91.875"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">假设一个 hash 函数计算得到的位置等概率地分布在 bit 数组范围内，那么对于一个 bit 位，一次 hash 后它为 0 的概率是：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="35" longdesc="__SVG__0a0e41414c5c899eb78f0d87ab604171" name="917d69fd-674a-4b97-9492-93a6bee22d96" src="/assets/img/3a3f74450849b76c66a1fa061bafc442" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="45.5"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">一个元素被加入集合后，该 bit 依然为 0 的概率是:</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="35" longdesc="__SVG__8c8a141f5f06239a947f63ecee912d1a" name="5219ed46-b897-422d-8896-d56cd322fe77" src="/assets/img/3ca526f77ac60003c4940713b638f744" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="64.75"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">n 个元素加入集合后，该 bit 为 0 的概率是：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="35" longdesc="__SVG__b248223a173a7e0820d9a99767288a1c" name="3631d460-cf6a-42ed-8a14-001f380941d4" src="/assets/img/383a1e8b66b37b4c278b09d1c90c4ad2" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="70"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">现在查询一个不在集合中的元素，当它所对应的 k 个位置都为 1 时会发生误判，这个概率 p 是：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="35" longdesc="__SVG__62f7f5ecb3825f28a43da5a35da7d80b" name="d75f0561-accd-45bb-a6d5-36b197c59e20" src="/assets/img/1ec224951a9dc5374b483d00e0eeb255" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="147"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">由于 <span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="21" longdesc="__SVG__def2cfae2ffe19ea9549ed57c528206b" name="47afbd38-33a5-4fd1-bc9b-b0805208f348" src="/assets/img/465f1ede2c492ca43b14e64dedbd68fe" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="58.625"/></span></span></span> 当x逼近0时约等于 <span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="8.75" longdesc="__SVG__8cd34385ed61aca950a6b06d09fb50ac" name="ede4cdc7-a9dc-4fc7-9883-ab987d321050" src="/assets/img/75f25960bd37ee2c9bbca26b6dc16542" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="7.875"/></span></span></span>，因此有：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="22.75" longdesc="__SVG__8819592ebd363717b5744c8bdeb8c97e" name="f695b158-d3fd-4656-98c4-3ee6dfde4a01" src="/assets/img/db202236a900df746ed3ea351b644305" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="100.625"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">对于该函数，省略<a href="http://www.cnblogs.com/allensun/archive/2011/02/16/1956532.html" style="background: transparent; color: #1980e6; text-decoration: none;" target="_blank">推导过程</a>给出结论，如果给定 m 和 n，当 k 取以下值时，误判率 p 的值最小：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="31.5" longdesc="__SVG__d0f21a74f0f60b2eb49f1dc1905adb51" name="a37a921c-7381-47a2-a072-31a159ef31cd" src="/assets/img/6ba77ff68d269ad4bd637e9d6185b8b5" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="204.75"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">此时误判率 p 等于：</p>
</div><div>
<p style="margin: 0 0 1.1em;"></p><div><div style="text-align: center; margin: 1em 0; position: relative; display: block; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%;"><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="35" longdesc="__SVG__76302e00007f3fc71bef329972149b2c" name="c9b51cd1-2056-4391-9c8e-1e56b1730c25" src="/assets/img/8363f29e9b1a4ecbc0312670785f2c45" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="287"/></span></span></div></div><p style="margin: 0 0 1.1em;"></p>
<p style="margin: 0 0 1.1em;">公式1 和 公式2 是实现一个 BloomFilter 需要的理论支撑。</p>
</div><div>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0; text-align: start;">3. 实现</h2>
<p style="margin: 0 0 1.1em;">一个 BloomFilter 需要用户提供两个参数：</p>
<ol style="margin-top: 0; margin-bottom: 1.1em;"><li><span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="8.75" longdesc="__SVG__55a049b8f161ae7cfeb0197d75aff967" name="c2f847df-a403-4c11-8f3d-87863844715d" src="/assets/img/00be7af32fa678fb14aa7949db3cd749" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="8.75"/></span></span></span>，预计集合规模；</li>
<li><span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="12.25" longdesc="__SVG__2ec6e630f199f589a2402fdf3e0289d5" name="9804cb66-bdca-4e70-8df7-4e34d534a09a" src="/assets/img/a5431188b86a69d2fb0e9c26d1c9ec41" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="9.625"/></span></span></span>，当元素个数达到 n 时，可以接受的误判率</li>
</ol>
<p style="margin: 0 0 1.1em;">bit 数组长度 <span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="8.75" longdesc="__SVG__0e51a2dede42189d77627c4d742822c3" name="50bc9a89-d6de-4a0f-a6b5-6f88ba5088ba" src="/assets/img/ca41d9196c4359d8e00b700b588b4bf0" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="12.25"/></span></span></span> 和 hash 函数个数 <span><span style="font-size: 100%; display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0; vertical-align: middle;"><span><img class="en-media" height="12.25" longdesc="__SVG__63bb9849783d01d91403bc9a5fea12a2" name="18d6c45d-3ca4-457e-a217-2c7523dca466" src="/assets/img/91302547231977d94cfd057b3e8be3d9" style="margin-top: 0; margin-bottom: 0; border: 0; vertical-align: middle; max-width: 100%;" width="7.875"/></span></span></span> 在初始化时由上述两个公式计算而得。</p>
<p style="margin: 0 0 1.1em;">在爬虫项目中用了 BloomFilter 作为 url 的判重器，代码在<a href="http://gist.github.com/novoland/9277fe26b4ec91cb3ee6" style="background: transparent; color: #1980e6; text-decoration: none;" target="_blank">这里</a>。其中 k 个 hash 函数是通过为 MD5 提供 k 个不同的 salt 构造的。实际使用中当集合规模为 500 万，误判率为万分之一时，所占空间仅为 11.5M。</p>
</div><div>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0; text-align: start;">4. 其他技巧</h2>
<ol style="margin-top: 0; margin-bottom: 1.1em;"><li><p style="margin: 0 0 1.1em;">两个 BloomFilter 的交集、并集</p>
<pre style="font-family: Source Code Pro,monospace; font-size: .9em; white-space: pre-wrap; display: block; padding: 2px; margin: 0 0 1.1em; line-height: 1.45; word-break: break-word; word-wrap: break-word; color: #333; background-color: rgba(102,128,153,0.05); border: 0; border-radius: 5px; text-align: start; background: #f6f6f6;" xml:space="preserve"><code style="font-family: Source Code Pro,monospace; font-size: inherit; padding: 18px 28px; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 0; display: block; background: #23241f;">filter1 | filter2 == 并集
filter1 &amp; filter2 == 交集</code></pre></li>
<li><p style="margin: 0 0 1.1em;"><strong style="font-weight: bold;"><code style="font-family: Source Code Pro,monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">counting BloomFilter</code></strong></p>
<p style="margin: 0 0 1.1em;">传统 BloomFilter 只能添加元素，不能对元素计数，也无法删除元素。如果把底层数组的 bit 换成 int，就可以支持计数和删除动作。每次插入元素时，将对应的 k 个 int 加一；查询时，返回 k 个 int 的最小值；删除时，将对应的 k 个 int 减一。</p></li>
</ol></div><div></div></div>