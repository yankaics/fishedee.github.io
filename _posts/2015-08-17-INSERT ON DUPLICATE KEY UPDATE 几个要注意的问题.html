---
layout: post
title: "INSERT ON DUPLICATE KEY UPDATE 几个要注意的问题"
category: "数据库"
---

<div style="color: #2c3f51; font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif; line-height: 1.6;">
<div style="line-height: 1.6;"></div>
<div style="line-height: 1.6;">
</div><div style="line-height: 1.6;">

<p style="margin: 0 0 1.1em; line-height: 1.6;"></p></div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">1. rows affected 是多少？</h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;">根据官方文档：</p>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">For INSERT … ON DUPLICATE KEY UPDATE statements, the affected-rows value per row is 1 if the row is inserted as a new row, 2 if an existing row is updated, and 0 if an existing row is set to its current values. If you specify the CLIENT_FOUND_ROWS flag, the affected-rows value is 1 (not 0) if an existing row is set to its current values.</p>
</blockquote>
<p style="margin: 0 0 1.1em; line-height: 1.6;">总结下，insert 1，update 2，update 的值和原来的值一样 0。但如果通过 JDBC 调用，最后一种情况也会返回1，这是因为客户端连接时如果设置了 CLIENT_FOUND_ROWS 标志，会用 rows found 代替 rows affected 当做返回值，而JDBC默认是会设置该标志的。在 JDBC 连接字符串中指定 <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">useAffectedRows=true</code> 可以取消这个flag。</p>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;"><strong style="font-weight: bold; line-height: 1.6;">useAffectedRows</strong> <br/>
  Don’t set the CLIENT_FOUND_ROWS flag when connecting to the server (not JDBC-compliant, will break most applications that rely on “found” rows vs. “affected rows” for DML statements), but does cause “correct” update counts from “INSERT … ON DUPLICATE KEY UPDATE” statements to be returned by the server. <br/>
  Default: false <br/>
  Since version: 5.1.7</p>
</blockquote>
</div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">2. 执行后，<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">select LAST_INSERT_ID()</code> 返回什么？</h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;">上官方文档：</p>
<blockquote style="padding: 15px 20px; margin: 0 0 1.1em; border-left: 5px solid rgba(102,128,153,0.075); border-left-width: 10px; background-color: rgba(102,128,153,0.05); border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
<p style="margin: 0 0 1.1em; font-size: 1em; font-weight: 300; margin-bottom: 0; line-height: 1.6;">If a table contains an AUTO_INCREMENT column and INSERT … UPDATE inserts a row, the LAST_INSERT_ID() function returns the AUTO_INCREMENT value. If the statement updates a row instead, LAST_INSERT_ID() is not meaningful.</p>
</blockquote>
<p style="margin: 0 0 1.1em; line-height: 1.6;">insert：返回刚刚生成的自增ID，update：<strong style="font-weight: bold; line-height: 1.6;">返回值无意义</strong>，MyBatis实测返回0而不是null，因此DAO这么写：</p>
</div><div style="line-height: 1.6;">
<pre style="word-break: break-word; font-family: 'Source Code Pro',monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 2px; border: 0; border-radius: 5px; text-align: start;" xml:space="preserve"><code style="font-family: 'Source Code Pro',monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; background: #23241f; padding: 18px 28px;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><span style="line-height: 1.6;">@Insert</span>(<span style="line-height: 1.6; color: #e6db74;">" INSERT INTO ... ON DUPLICATE KEY UPDATE ..."</span>)</div><div style="line-height: 1.6;"><span style="line-height: 1.6;">@SelectKey</span>(statement = <span style="line-height: 1.6; color: #e6db74;">"SELECT LAST_INSERT_ID() AS id"</span>, keyProperty = <span style="line-height: 1.6; color: #e6db74;">"id"</span>, before = <span style="line-height: 1.6; color: #f92672;">false</span>, resultType = Long.class)</div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;"><span style="line-height: 1.6; color: #66d9ef;">int</span> <span style="line-height: 1.6; color: #a6e22e;">insert</span><span style="line-height: 1.6; color: #f8f8f2;">(Entity obj)</span></span>;</div></div></div></div></div></code></pre>
<p style="margin: 0 0 1.1em; line-height: 1.6;">然后调用方试图通过观察 id 是否为null，推测是发生了更新还是插入，这是行不通的。</p>
<p style="margin: 0 0 1.1em; line-height: 1.6;">要获得插入或者更新的ID，可以在SQL执行完后，利用唯一索引再把id查出来：</p>
</div><div style="line-height: 1.6;">
<pre style="word-break: break-word; font-family: 'Source Code Pro',monospace; white-space: pre-wrap; display: block; background-color: rgba(102,128,153,0.05); color: #333; word-wrap: break-word; font-size: .9em; background: #f6f6f6; line-height: 1.6; margin: 0 0 1.1em; padding: 2px; border: 0; border-radius: 5px; text-align: start;" xml:space="preserve"><code style="font-family: 'Source Code Pro',monospace; font-size: inherit; background-color: transparent; white-space: pre-wrap; border-radius: 0; color: #f8f8f2; display: block; background: #23241f; padding: 18px 28px;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><div style="line-height: 1.6;"><span style="line-height: 1.6;">@Insert</span>(<span style="line-height: 1.6; color: #e6db74;">" INSERT INTO t(v) VALUES(#{v}) ON DUPLICATE KEY UPDATE v=#{v}"</span>)</div><div style="line-height: 1.6;"><span style="line-height: 1.6;">@SelectKey</span>(statement = <span style="line-height: 1.6; color: #e6db74;">"SELECT id FROM t WHERE v=#{v}"</span>, keyProperty = <span style="line-height: 1.6; color: #e6db74;">"id"</span>, before = <span style="line-height: 1.6; color: #f92672;">false</span>, resultType = Long.class)</div><div style="line-height: 1.6;"><span style="line-height: 1.6; color: #f92672;"><span style="line-height: 1.6; color: #66d9ef;">int</span> <span style="line-height: 1.6; color: #a6e22e;">insert</span><span style="line-height: 1.6; color: #f8f8f2;">(Entity obj)</span></span>;</div></div></div></div></div></code></pre>
</div><div style="line-height: 1.6;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 21px; margin-bottom: 10.5px; font-size: 2.15em; margin: 1.2em 0 .6em 0; text-align: start;">3. AUTO_INCREMENT 字段的GAP</h2>
<p style="margin: 0 0 1.1em; line-height: 1.6;">根据<a href="https://www.evernote.com/OutboundRedirect.action?dest=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.5%2Fen%2Finnodb-auto-increment-handling.html" style="background: transparent; color: #1980e6; text-decoration: none;" target="_blank">官方文档</a>的描述，<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">INSERT ON DUPLICATE KEY UPDATE</code> 属于 <strong style="font-weight: bold; line-height: 1.6;">Mixed-mode inserts</strong>，只分析SQL无法知道需要几个自增id，在 <code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">innodb_autoinc_lock_mode</code> 为 1（默认值）或 2 时，这类 insert 不走 AUTO_INC 表级锁，而是用一个轻量级的 mutex，一次性分配最坏情况下所需要的自增id，至于用不用的完就不管了。上锁的只是分配id的过程，不会锁整个sql语句，这样一来提高了并发度，但代价是和后续insert分配的自增id之间可能存在空洞。具体到<code style="font-family: 'Source Code Pro',monospace; font-size: .9em; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: normal; border-radius: 4px;">INSERT ON DUPLICATE KEY UPDATE</code>，即使最终执行了 update，自增ID也是会增长的，不过这一般不是问题。</p></div><div style="line-height: 1.6;"></div></div>